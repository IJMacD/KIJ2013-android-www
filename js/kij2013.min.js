var KIJ2013=function(){var c={key:"preferences"},f="preferences",e,d,a,b;return{init:function(g){b=Lawnchair({name:f},function(){this.get("preferences",function(h){if(h){c=h}if(typeof g=="function"){g()}})});$("#menu a").each(function(){$(this).click(function(){KIJ2013.navigateTo($(this).text())})});KIJ2013.setActionBarUp();$("section").hide();$("#menu").show();a=$("#popup");e=$("#loading")},getPreference:function(g,h){return c[g]||h||null},setPreference:function(g,h){if(g=="key"){return}c[g]=h;b.save(c)},navigateTo:function(h){var i=$("section:visible"),g;$.each(i,function(j,k){g=$(k).attr("id");g=g.slice(0,1).toUpperCase()+g.slice(1);if(KIJ2013[g]&&typeof KIJ2013[g].hide=="function"){KIJ2013[g].hide()}});i.hide();$("#"+h.toLowerCase()).show();KIJ2013.setActionBarUp("Menu");KIJ2013.setTitle(h);if(KIJ2013[h]&&typeof KIJ2013[h].init=="function"){KIJ2013[h].init()}KIJ2013.scrollTop()},setActionBarUp:function(g){if(typeof g=="function"){$("#up-button").removeAttr("href").unbind().click(function(){g();return false});$("#up-icon").css({visibilty:"normal"})}else{if(typeof g=="string"){$("#up-button").unbind().click(function(){KIJ2013.navigateTo(g);return false});$("#up-icon").css("visibility","visible")}else{if(typeof g=="undefined"){$("#up-icon").css("visibility","hidden")}}}},setTitle:function(h){var i=typeof h=="undefined"||h=="",g="KIJ2013";$("title").text(i?g:g+" - "+h);$("#action_bar h1").text(i?g:h)},showLoading:function(){if(e.length==0){e=$("<div/>").attr("id","loading").text("Loading").append($("<img/>").attr("src","img/ajax-loader.gif")).appendTo("#body")}d=$("section:visible").hide();e.show()},hideLoading:function(){e.hide();if(d){d.show();d=null}},showError:function(g){if(a.length==0){a=$("<div/>").attr("id","popup").appendTo("body")}a.text(g).show();setTimeout(function(){a.slideUp("normal")},5000)},scrollTop:function(){setTimeout(function(){window.scrollTo(0,1)},10)}}}();KIJ2013.Util=function(){return{filter:function(c,b,e,d){var a=function(f){return d?d(f[c]):f[c]};b=arguments.length==2?arguments[1]:arguments[2];e=arguments.length==2?"=":arguments[1];return function(g){var f=a(g);return e=="="?f==b:(e==">"?f>b:(e=="<"?f<b:true))}},sort:function(c,a,d){var b=function(e){return d?d(e[c]):e[c]};a=typeof a=="undefined"||a;return function(g,f){var e=b(g),h=b(f);return(e<h?-1:(e>h?+1:0))*[-1,1][+!!a]}},merge:function(){var c=[],f,e,a,d,b;for(d=0,e=arguments.length;d<e;d++){f=arguments[d];for(b=0,a=f.length;b<a;b++){if(c.indexOf(f[b])===-1){c.push(f[b])}}}return c}}}();KIJ2013.Menu=function(){return{init:function(){KIJ2013.setActionBarUp();KIJ2013.setTitle()}}}();KIJ2013.News=function(){var c="feed.php?f=news.rss",h="news",b,g=function(){b=new Lawnchair({name:h},function(){})},e=function(){$.get(c,function(j){var i=[];$(j).find("item").each(function(k,l){i.push({key:$(l).find("guid").text(),title:$(l).find("title").text(),date:(new Date($(l).find("pubDate").text()))/1000,description:$(l).find("content\\:encoded, encoded").text()||$(l).find("description").text()})});b.batch(i,function(){d()})},"xml").error(function(k,i,j){KIJ2013.showError("Error Fetching Items: "+i)})},f=function(j){var i=$(j.target);a(i.data("guid"))},d=function(){KIJ2013.setActionBarUp("Menu");KIJ2013.setTitle("News");KIJ2013.scrollTop();b.all(function(i){if(i.length){i.sort(KIJ2013.Util.sort("date",false));var j=$("<ul/>").attr("id","news-list").addClass("listview");$.each(i,function(l,n){var k,m;k=$("<li/>");m=$("<a/>").attr("id",n.key).text(n.title);m.data("guid",n.key);m.click(f);k.append(m);j.append(k)});$("#news").empty().append(j);KIJ2013.hideLoading()}else{KIJ2013.showLoading()}})},a=function(i){KIJ2013.setActionBarUp(d);b.get(i,function(k){var j=$("<div/>").css({padding:"10px"});KIJ2013.setTitle(k.title);$("<h1/>").text(k.title).appendTo(j);j.append(k.description);$("#news").empty().append(j);KIJ2013.scrollTop()})};return{init:function(){g();d();e()}}}();KIJ2013.Events=function(){var b="events.json",f="events",e,i=function(){e=new Lawnchair({name:f},function(){})},h=function(){$.get(b,function(k){var j=[];$(k).each(function(l,m){e.get(m.guid,function(n){n=n||{};j.push({key:m.guid,title:m.title,date:m.date,category:m.category,remind:!!n.remind||!!m.remind,description:m.description})})});e.batch(j,function(){d()})},"json").error(function(l,j,k){KIJ2013.showError("Error Fetching Events: "+j)})},c=function(){g($(this).data("guid"))},a=function(l){var j=l.data.guid,k="selected",m=$(this).toggleClass(k).hasClass(k);e.get(j,function(n){n.remind=m;e.save(n)});return false},d=function(){KIJ2013.setActionBarUp("Menu");KIJ2013.setTitle("Events");var j=KIJ2013.getPreference("subcamp");e.all(function(q){var o=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],p,l,r,s,m,n,t,u,k;if(q.length){q=q.filter(KIJ2013.Util.filter("date",">",(new Date())/1000));if(j){q=KIJ2013.Util.merge(q.filter(KIJ2013.Util.filter("category",j)),q.filter(KIJ2013.Util.filter("category","all")))}q.sort(KIJ2013.Util.sort("date"));p=$("<ul/>").attr("id","event-list").addClass("listview");$.each(q,function(v,w){r=w.key;s=$("<li/>");l=$("<a/>").attr("id",r);m=new Date(w.date*1000);n=$("<p/>").addClass("date-text").text(m.getDate()+" "+o[m.getMonth()]);t=$("<p/>").addClass("title").text(w.title);u=$("<a/>").addClass("remind-btn button").addClass(w.remind?"selected":"").text("Remind").click({guid:r},a);k=$("<p/>").addClass("category").text(w.category);l.data("guid",r);l.click(c);l.append(n).append(t).append(u).append(k);s.append(l);p.append(s)});$("#events").empty().append(p);KIJ2013.hideLoading()}else{KIJ2013.showLoading()}})},g=function(j){KIJ2013.setActionBarUp(d);KIJ2013.scrollTop();e.get(j,function(m){if(m){var l=$("<div/>").css({padding:"10px"}),k=new Date(m.date*1000);KIJ2013.setTitle(m.title);$("#events").empty();$("<h1/>").text(m.title).appendTo(l);$("<p/>").addClass("date-text").text(k.toLocaleString()).appendTo(l);$("<a/>").addClass("button").addClass(m.remind?"selected":"").text("Remind").click({guid:j},a).appendTo(l);$("<p/>").attr("id","remind-text").text(m.remind?"You will be reminded about this event.":"You will not be reminded about this event").appendTo(l);$("<p/>").addClass("category").text(m.category).appendTo(l);$("<p/>").text(m.description).appendTo(l);$("#events").append(l)}})};return{init:function(){i();d();h()}}}();KIJ2013.Map=function(){var c=[0.5785846710205073,51.299361979488744,0.5925965309143088,51.305519711648124],f=[2516,1867],i=f[0]/(c[2]-c[0]),a=f[1]/(c[3]-c[1]),d,e,h=false,g=function(j){if(j<c[0]){throw"OutOfBounds"}if(j>c[2]){throw"OutOfBounds"}return(j-c[0])*i},b=function(j){if(j<c[1]){throw"OutOfBounds"}if(j>c[3]){throw"OutOfBounds"}return(j-c[1])*a};return{init:function(){var j=navigator.geolocation;if(!h){d=$("#map img");if(d.length==0){KIJ2013.showLoading();d=$("<img />").attr("src","img/map.png").appendTo("#map").load(KIJ2013.hideLoading)}e=$("#marker");h=true}if(j){j.getCurrentPosition(function(k){var l=k.coords,m=l.latitude,n=l.longitude;KIJ2013.Map.mark(m,n);setTimeout(function(){KIJ2013.Map.moveTo(m,n)},2)},function(){KIJ2013.showError("Error Finding Location")})}},moveTo:function(k,l){try{window.scrollTo(g(l),b(k))}catch(j){}},mark:function(k,l){try{e.css({display:"block",bottom:b(k),left:g(l)})}catch(j){}},unmark:function(){e.css({display:"none"})}}}();KIJ2013.Radio=function(){var b=false,c,a="http://31.3.242.244:8046/;stream/1";return{init:function(){if(!b){c=$("#player").jPlayer({cssSelectorAncestor:"#controls",nativeSupport:true,ready:function(){c.jPlayer("setMedia",{mp3:a}).jPlayer("play")},swfPath:"swf",volume:60,errorAlerts:true});b=true}KIJ2013.setTitle("Radio");KIJ2013.setActionBarUp("Menu")}}}();KIJ2013.Learn=function(){var h="learn",c="learn.php?id=",i="learn-",d,g,j=function(){g=new Lawnchair({name:h},function(){})},a=function(){f($(this).data("guid"))},e=function(){KIJ2013.setActionBarUp("Menu");KIJ2013.setTitle("Learn");KIJ2013.scrollTop();g.all(function(l){var k=l.length,m;if(k){m=$("<ul/>").attr("id","learn-list").addClass("listview");l.sort(KIJ2013.Util.sort("date",false));$.each(l,function(o,q){var p,n,r,s;s=q.key;n=$("<li/>").attr("id",i+s);r=q.title||"* New item";p=$("<a/>").text(r);p.data("guid",s);p.click(a);if(s==d){n.addClass("highlight");d=null}n.append(p);m.append(n)});$("#learn").empty().append(m)}})},f=function(k){KIJ2013.setActionBarUp(e);KIJ2013.scrollTop();g.get(k,function(m){if(m){var l=$("<div/>").css({padding:"10px"});if(!m.description){KIJ2013.showLoading();b(k,function(){KIJ2013.hideLoading();f(k)},function(){KIJ2013.hideLoading();KIJ2013.showError("Sorry, Could not find any information on that item.");e()})}else{KIJ2013.setTitle(m.title);$("<h1/>").text(m.title).appendTo(l);l.append(m.description);$("#learn").empty().append(l)}}})},b=function(m,l,k){$.get(c+m,function(n){g.get(m,function(o){o.title=n.title;o.description=n.description;g.save(o)})}).success(l).error(k)};return{init:function(){j();e()},add:function(k){if(!g){j()}g.get(k,function(l){if(!l){g.save({key:k,date:(new Date())/1000})}})},highlight:function(m){var l=$("#"+i+m),k="highlight";if(l.length){l.addClass(k);setTimeout(function(){l.removeClass(k)},3000)}else{d=m}}}}();KIJ2013.Barcode=function(){var d=$("#live")[0],f=$("<canvas>")[0],k=f.getContext("2d"),g=null,a=navigator,h=window,j=typeof qrcode!=="undefined"?qrcode:false,c=function(){if(g&&j){k.drawImage(d,0,0);j.decode(f.toDataURL("image/webp"))}},b,e,i;f.width=640;f.height=480;a.getUserMedia||(a.getUserMedia=a.webkitGetUserMedia);h.URL||(h.URL=h.webkitURL||h.msURL||h.oURL);b=function(l){return(h.URL&&h.URL.createObjectURL)?h.URL.createObjectURL(l):l};if(j){j.callback=function(l){if(l){var m=l.slice(26);if(l.slice(0,26)=="http://kij13.org.uk/learn/"){KIJ2013.Barcode.stop();KIJ2013.Learn.add(m);alert("Congratulations you found an item.");KIJ2013.navigateTo("Learn");KIJ2013.Learn.highlight(m)}else{alert(l)}}}}return{init:function(){if(a.getUserMedia){if(!i){a.getUserMedia({video:true},function(l){d.src=b(l);g=l;i=true;KIJ2013.Barcode.start()},function(l){console.log("Unable to get video stream!")})}else{KIJ2013.Barcode.start()}}else{KIJ2013.showError("Barcode Scanner is not available on your platform.")}},start:function(){d.play();if(e){clearInterval(e)}e=setInterval(c,1000)},stop:function(){d.pause();clearInterval(e)},hide:function(){KIJ2013.Barcode.stop()}}}();KIJ2013.Debug=function(){var e="news",d="events",c="learn",a="preferences",b=false;return{init:function(){if(!b){$("#subcamp").val(KIJ2013.getPreference("subcamp"));$("#clear-news").click(function(){Lawnchair({name:e},function(){this.nuke();alert("News Items Cleared")})});$("#clear-events").click(function(){Lawnchair({name:d},function(){this.nuke();alert("Events Cleared")})});$("#clear-learn").click(function(){Lawnchair({name:c},function(){this.nuke();alert("Learn Cleared")})});$("#clear-preferences").click(function(){Lawnchair({name:a},function(){this.nuke();alert("Preferences Cleared")})});$("#set-subcamp").click(function(){var f=$("#subcamp").val();KIJ2013.setPreference("subcamp",f);alert("'subcamp' set to '"+f+"'")});b=true}}}}();KIJ2013.init();